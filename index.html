<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secret Family Gift Exchange</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
        }
        #app {
            margin-bottom: 20px;
        }
        .member-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        .member-buttons button {
            padding: 10px;
            font-size: 16px;
            cursor: pointer;
        }
        .selected {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .current-device {
            background-color: #90ee90;
        }
        .device-indicator {
            font-size: smaller;
            font-weight: bold;
        }
        #progress-container {
            background: #eee;
            height: 10px;
            margin: 20px 0;
            border-radius: 5px;
            overflow: hidden;
        }
        #progress-bar {
            background: #4caf50;
            height: 100%;
            width: 0;
            transition: width 0.3s;
        }
        #modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .number-selection, .assignment-reveal, .celebration {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            max-width: 400px;
        }
        .number-selection .numbers {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        .number-selection button {
            padding: 10px;
            font-size: 18px;
        }
        .assignment-reveal h1 {
            color: #f00;
        }
        .celebration .gift-animation {
            font-size: 50px;
            animation: spin 2s infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #error-message {
            display: none;
            color: red;
            font-weight: bold;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div id="app">
        <h1>Secret Family Gift Exchange</h1>
        <p id="progress">0/8 family members have selected</p>
        <div id="progress-container">
            <div id="progress-bar"></div>
        </div>
        <div class="member-buttons">
            <button id="member-mum">Mum</button>
            <button id="member-dad">Dad</button>
            <button id="member-sherry">Sherry</button>
            <button id="member-nancy">Nancy</button>
            <button id="member-b">B</button>
            <button id="member-pius">Pius</button>
            <button id="member-kui">Kui</button>
            <button id="member-turi">Turi</button>
        </div>
    </div>
    <div id="modal"></div>
    <div id="error-message"></div>

    <script>
        class SecretGiftExchange {
            constructor() {
                // Initialize core properties
                this.familyMembers = ['Mum', 'Dad', 'Sherry', 'Nancy', 'B', 'Pius', 'Kui', 'Turi'];
                this.storageKey = 'secretGiftExchange';
                this.deviceKey = 'deviceGiftExchange';
                this.gameState = null;
                this.deviceId = null;
            }

            init() {
                this.deviceId = this.loadDeviceId();
                this.gameState = this.loadGameState();
                this.setupMultiTabSync();
                this.updateUI();

                // Add event listeners to member buttons
                this.familyMembers.forEach(member => {
                    const button = document.getElementById(`member-${member.toLowerCase()}`);
                    if (button) {
                        button.addEventListener('click', () => {
                            this.selectMember(member);
                        });
                    }
                });
            }

            generateDeviceId() {
                // Create unique identifier per device/browser
                const timestamp = Date.now();
                const random = Math.random().toString(36).substring(2);
                const userAgent = navigator.userAgent.slice(-10);
                return `${timestamp}-${random}-${userAgent}`;
            }

            generateSecretMapping() {
                // Create random 1-8 to family member mapping
                const shuffled = [...this.familyMembers];
                
                // Fisher-Yates shuffle for true randomness
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                
                // Map numbers 1-8 to shuffled family members
                const mapping = {};
                for (let i = 0; i < 8; i++) {
                    mapping[i + 1] = shuffled[i];
                }
                
                return mapping;
            }

            canDeviceSelect(deviceId, memberName) {
                // Check if device already used
                if (this.gameState.deviceSelections[deviceId]) {
                    const previousSelection = this.gameState.deviceSelections[deviceId];
                    return {
                        canSelect: false,
                        reason: 'DEVICE_USED',
                        previousMember: previousSelection
                    };
                }
                
                // Check if member already selected by someone else
                if (this.gameState.selections[memberName]) {
                    return {
                        canSelect: false,
                        reason: 'MEMBER_TAKEN',
                        takenBy: 'another device'
                    };
                }
                
                return { canSelect: true };
            }

            selectMember(memberName) {
                // 1. Validate device can select
                const validation = this.canDeviceSelect(this.deviceId, memberName);
                if (!validation.canSelect) {
                    this.showError(validation);
                    return false;
                }
                
                // 2. Mark member as selected
                this.gameState.selections[memberName] = {
                    selected: true,
                    timestamp: Date.now(),
                    deviceId: this.deviceId
                };
                
                // 3. Record device selection
                this.gameState.deviceSelections[this.deviceId] = memberName;
                
                // 4. Update UI and save state
                this.saveGameState();
                this.updateUI();
                this.showNumberSelection(memberName);
                
                return true;
            }

            selectNumber(memberName, number) {
                // Get recipient from secret mapping
                const recipient = this.gameState.secretMapping[number];
                
                // Mark number as used
                this.gameState.usedNumbers = this.gameState.usedNumbers || [];
                this.gameState.usedNumbers.push(number);
                
                // Show assignment temporarily (10 seconds)
                this.showAssignment(memberName, recipient, number);
                
                // Save final state
                this.saveGameState();
                
                // Check if game complete
                this.checkCompletion();
            }

            saveGameState() {
                try {
                    const dataToSave = {
                        ...this.gameState,
                        timestamp: Date.now(),
                        version: '1.0'
                    };
                    localStorage.setItem(this.storageKey, JSON.stringify(dataToSave));
                    return true;
                } catch (error) {
                    console.error('Failed to save game state:', error);
                    this.showError({ reason: 'SAVE_ERROR' });
                    return false;
                }
            }

            loadGameState() {
                try {
                    const saved = localStorage.getItem(this.storageKey);
                    if (!saved) return this.createNewGame();
                    
                    const parsed = JSON.parse(saved);
                    
                    // Validate data structure
                    if (!this.validateGameState(parsed)) {
                        return this.createNewGame();
                    }
                    
                    return parsed;
                } catch (error) {
                    console.error('Failed to load game state:', error);
                    return this.createNewGame();
                }
            }

            loadDeviceId() {
                let deviceId = localStorage.getItem(this.deviceKey);
                if (!deviceId) {
                    deviceId = this.generateDeviceId();
                    localStorage.setItem(this.deviceKey, deviceId);
                }
                return deviceId;
            }

            setupMultiTabSync() {
                // Listen for localStorage changes from other tabs
                window.addEventListener('storage', (e) => {
                    if (e.key === this.storageKey) {
                        // Another tab updated the game state
                        this.gameState = this.loadGameState();
                        this.updateUI();
                        this.showUpdateNotification();
                    }
                });
                
                // Handle page visibility changes
                document.addEventListener('visibilitychange', () => {
                    if (!document.hidden) {
                        this.gameState = this.loadGameState();
                        this.updateUI();
                    }
                });
            }

            updateMemberButtons() {
                this.familyMembers.forEach(member => {
                    const button = document.getElementById(`member-${member.toLowerCase()}`);
                    const isSelected = this.gameState.selections[member];
                    const isCurrentDevice = this.gameState.deviceSelections[this.deviceId] === member;
                    
                    // Update button appearance based on state
                    if (isSelected) {
                        button.disabled = true;
                        button.classList.add('selected');
                        
                        if (isCurrentDevice) {
                            button.classList.add('current-device');
                            button.innerHTML = `${member} <span class="device-indicator">(YOU)</span>`;
                        }
                    } else {
                        button.disabled = false;
                        button.classList.remove('selected', 'current-device');
                        button.innerHTML = member;
                    }
                });
            }

            updateProgress() {
                const selectedCount = Object.keys(this.gameState.selections).length;
                const total = this.familyMembers.length;
                
                const progressElement = document.getElementById('progress');
                progressElement.textContent = `${selectedCount}/${total} family members have selected`;
                
                // Update progress bar
                const percentage = (selectedCount / total) * 100;
                document.getElementById('progress-bar').style.width = `${percentage}%`;
            }

            showAssignment(giver, recipient, number) {
                // Create assignment display
                const assignmentHtml = `
                    <div class="assignment-reveal">
                        <h2>🎁 Your Secret Assignment</h2>
                        <p><strong>${this.escapeHtml(giver)}</strong>, you will give a gift to:</p>
                        <h1 class="recipient">${this.escapeHtml(recipient)}</h1>
                        <p class="number-info">You selected number ${number}</p>
                        <div class="countdown">This will disappear in <span id="countdown">10</span> seconds</div>
                    </div>
                `;
                
                // Show with countdown
                this.showModal(assignmentHtml);
                this.startCountdown(10, () => {
                    this.hideModal();
                    this.returnToMainScreen();
                });
            }

            checkCompletion() {
                const selectedCount = Object.keys(this.gameState.selections).length;
                
                if (selectedCount === this.familyMembers.length) {
                    this.gameState.completed = true;
                    this.gameState.completedAt = Date.now();
                    this.saveGameState();
                    this.showCompletionCelebration();
                }
            }

            showCompletionCelebration() {
                const celebrationHtml = `
                    <div class="celebration">
                        <h1>🎉 All Done! 🎉</h1>
                        <p>Everyone has selected their secret assignments!</p>
                        <p>Your December gift exchange is ready!</p>
                        <div class="gift-animation">🎁✨</div>
                    </div>
                `;
                this.showModal(celebrationHtml);
                // Note: This modal stays open; you can add a close button if needed.
            }

            showError(validation) {
                let message = '';
                
                switch (validation.reason) {
                    case 'DEVICE_USED':
                        message = `🚫 This device has already been used! ${this.escapeHtml(validation.previousMember)} was already selected from this device.`;
                        break;
                    case 'MEMBER_TAKEN':
                        message = `🚫 This family member has already been selected by someone else! Choose a different family member.`;
                        break;
                    case 'SAVE_ERROR':
                        message = `🚫 Failed to save your selection. Please try again.`;
                        break;
                    default:
                        message = `🚫 Something went wrong. Please try again.`;
                }
                
                this.displayErrorMessage(message);
            }

            validateGameState(state) {
                // Check required properties
                if (!state.secretMapping || !state.selections || !state.deviceSelections) {
                    return false;
                }
                
                // Validate secret mapping
                const mappingNumbers = Object.keys(state.secretMapping).map(Number).sort();
                const expectedNumbers = [1, 2, 3, 4, 5, 6, 7, 8];
                if (JSON.stringify(mappingNumbers) !== JSON.stringify(expectedNumbers)) {
                    return false;
                }
                
                // Validate family members in mapping
                const mappingMembers = Object.values(state.secretMapping);
                for (const member of mappingMembers) {
                    if (!this.familyMembers.includes(member)) {
                        return false;
                    }
                }

                // Ensure unique members
                const uniqueMembers = new Set(mappingMembers);
                if (uniqueMembers.size !== this.familyMembers.length) {
                    return false;
                }
                
                return true;
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            sanitizeInput(input) {
                if (typeof input !== 'string') return '';
                return this.escapeHtml(input.trim());
            }

            createNewGame() {
                const mapping = this.generateSecretMapping();
                const state = {
                    secretMapping: mapping,
                    selections: {},
                    deviceSelections: {},
                    usedNumbers: [],
                    completed: false,
                    version: '1.0'
                };
                this.gameState = state;
                this.saveGameState();
                return state;
            }

            showNumberSelection(memberName) {
                const used = this.gameState.usedNumbers || [];
                let html = `<div class="number-selection">
                    <h2>${this.escapeHtml(memberName)}, Select Your Number</h2>
                    <div class="numbers">`;
                for (let i = 1; i <= 8; i++) {
                    if (!used.includes(i)) {
                        html += `<button class="number-btn" data-number="${i}">${i}</button>`;
                    } else {
                        html += `<button disabled>${i}</button>`;
                    }
                }
                html += '</div></div>';
                this.showModal(html);

                // Add event listeners to number buttons
                document.querySelectorAll('.number-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const num = parseInt(btn.dataset.number);
                        this.selectNumber(memberName, num);
                    });
                });
            }

            showModal(html) {
                const modal = document.getElementById('modal');
                modal.innerHTML = html;
                modal.style.display = 'flex';
            }

            hideModal() {
                document.getElementById('modal').style.display = 'none';
            }

            startCountdown(seconds, callback) {
                let count = seconds;
                const span = document.getElementById('countdown');
                if (!span) return callback();
                span.textContent = count;
                const interval = setInterval(() => {
                    count--;
                    span.textContent = count;
                    if (count <= 0) {
                        clearInterval(interval);
                        callback();
                    }
                }, 1000);
            }

            displayErrorMessage(msg) {
                const err = document.getElementById('error-message');
                err.innerHTML = msg;
                err.style.display = 'block';
                setTimeout(() => {
                    err.style.display = 'none';
                }, 5000);
            }

            returnToMainScreen() {
                this.hideModal();
                this.updateUI();
            }

            showUpdateNotification() {
                // Simple notification
                this.displayErrorMessage('Game state updated from another tab/window!');
            }

            updateUI() {
                this.updateMemberButtons();
                this.updateProgress();
            }
        }

        const app = new SecretGiftExchange();
        app.init();
    </script>
</body>
</html>