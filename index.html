<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üéÅ The Wainaina's Secret Gift Exchange</title>
  <style>
    body {
      font-family: 'Georgia', serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0;
      padding: 20px;
      min-height: 100vh;
    }
    .container {
      max-width: 900px;
      margin: auto;
      background: rgba(255, 255, 255, 0.95);
      padding: 35px;
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
      backdrop-filter: blur(10px);
    }
    .family-title {
      text-align: center;
      font-size: 2.5rem;
      color: #2c3e50;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
      font-weight: bold;
    }
    .subtitle {
      text-align: center;
      font-size: 1.1rem;
      color: #7f8c8d;
      margin-bottom: 30px;
      font-style: italic;
    }
    .loading, .error, .connected-status {
      text-align: center;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      font-size: 1.1rem;
    }
    .loading { 
      background: linear-gradient(45deg, #eaf4ff, #d1ecf1); 
      color: #0056b3; 
      border: 2px solid #b3d9ff;
    }
    .error { 
      background: linear-gradient(45deg, #ffeaea, #ffcccb); 
      color: #c00; 
      border: 2px solid #ff9999;
    }
    .connected-status { 
      background: linear-gradient(45deg, #eaffea, #d4f5d4); 
      color: #006600; 
      border: 2px solid #99ff99;
    }
    .status-section { 
      margin-bottom: 25px; 
      text-align: center;
    }
    .progress { 
      font-weight: bold; 
      font-size: 1.2rem;
      color: #2c3e50;
    }
    .completed-list { 
      margin-top: 15px; 
      font-size: 1rem; 
      color: #7f8c8d; 
    }
    .reset-button {
      margin-top: 15px;
      padding: 10px 20px;
      border: none;
      background: linear-gradient(45deg, #e74c3c, #c0392b);
      color: #fff;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      transition: transform 0.2s;
    }
    .reset-button:hover {
      transform: scale(1.05);
    }
    .initial-prompt {
      text-align: center;
      padding: 30px;
      background: linear-gradient(45deg, #fff9e6, #fff3cd);
      border-radius: 15px;
      margin-bottom: 30px;
      border: 2px solid #ffd700;
    }
    .initial-prompt h2 {
      color: #d68910;
      font-size: 1.8rem;
      margin-bottom: 15px;
    }
    .initial-prompt p {
      color: #7d5f00;
      font-size: 1.1rem;
      margin: 10px 0;
    }
    .welcome-message {
      display: none;
      text-align: center;
      padding: 25px;
      background: linear-gradient(45deg, #e8f5e8, #d4eed4);
      border-radius: 15px;
      margin-bottom: 25px;
      border: 2px solid #28a745;
    }
    .welcome-message h2 {
      color: #155724;
      font-size: 1.8rem;
      margin-bottom: 15px;
    }
    .welcome-message p {
      color: #155724;
      font-size: 1.1rem;
    }
    .instructions {
      margin: 25px 0;
      background: linear-gradient(45deg, #f8f9ff, #e6f2ff);
      padding: 25px;
      border-radius: 15px;
      border: 2px solid #4dabf7;
    }
    .instructions h3 {
      color: #1971c2;
      font-size: 1.5rem;
      margin-bottom: 15px;
    }
    .instructions ol {
      color: #495057;
      font-size: 1rem;
    }
    .instructions li {
      margin: 10px 0;
      padding: 5px 0;
    }
    .privacy-notice {
      margin-bottom: 25px;
      padding: 20px;
      background: linear-gradient(45deg, #fff8e1, #ffecb3);
      border-radius: 12px;
      font-size: 1rem;
      border: 2px solid #ffc107;
    }
    .privacy-notice strong {
      color: #e65100;
    }
    .device-blocked {
      display: none;
      padding: 25px;
      background: linear-gradient(45deg, #ffeaea, #ffcccb);
      border: 2px solid #dc3545;
      border-radius: 15px;
      margin-bottom: 25px;
      text-align: center;
    }
    .family-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 15px;
      margin-bottom: 25px;
    }
    .family-member {
      padding: 20px;
      background: linear-gradient(45deg, #f8f9fa, #e9ecef);
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid transparent;
      font-size: 1.1rem;
      font-weight: 600;
    }
    .family-member:hover { 
      background: linear-gradient(45deg, #d0ebff, #a5d8ff);
      transform: translateY(-2px);
      border-color: #339af0;
      box-shadow: 0 4px 15px rgba(51, 154, 240, 0.3);
    }
    .family-member.completed { 
      background: linear-gradient(45deg, #d4f5d4, #a8e6a8);
      cursor: not-allowed;
      border-color: #28a745;
    }
    .numbers-section { 
      display: none; 
      margin-bottom: 25px; 
    }
    .numbers-title {
      text-align: center;
      color: #2c3e50;
      font-size: 1.5rem;
      margin-bottom: 20px;
    }
    .numbers-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
      max-width: 400px;
      margin: 0 auto;
    }
    .number-btn {
      padding: 20px;
      background: linear-gradient(45deg, #f8f9fa, #e9ecef);
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 1.3rem;
      font-weight: bold;
      border: 2px solid transparent;
    }
    .number-btn:hover { 
      background: linear-gradient(45deg, #d0ebff, #a5d8ff);
      transform: translateY(-2px);
      border-color: #339af0;
      box-shadow: 0 4px 15px rgba(51, 154, 240, 0.3);
    }
    .number-btn.used { 
      background: linear-gradient(45deg, #ffebee, #ffcdd2);
      cursor: not-allowed;
      border-color: #f44336;
      opacity: 0.6;
    }
    .assignment-result {
      display: none;
      padding: 30px;
      background: linear-gradient(45deg, #f3e5f5, #e1bee7);
      border-radius: 15px;
      text-align: center;
      border: 2px solid #9c27b0;
    }
    .assignment-result h3 {
      color: #4a148c;
      font-size: 1.8rem;
      margin-bottom: 20px;
    }
    .assignment-result p {
      color: #4a148c;
      font-size: 1.2rem;
    }
    .celebration {
      display: none;
      padding: 40px;
      background: linear-gradient(45deg, #fff3e0, #ffe0b2);
      border-radius: 20px;
      text-align: center;
      border: 3px solid #ff9800;
      box-shadow: 0 8px 25px rgba(255, 152, 0, 0.3);
    }
    .celebration h2 {
      color: #e65100;
      font-size: 2.2rem;
      margin-bottom: 20px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    }
    .celebration p {
      color: #bf360c;
      font-size: 1.3rem;
      margin: 15px 0;
    }
    @media (max-width: 768px) {
      .container {
        padding: 20px;
        margin: 10px;
      }
      .family-title {
        font-size: 2rem;
      }
      .family-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      .numbers-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="family-title">The Wainaina's</h1>
    <p class="subtitle">üéÅ Secret Family Gift Exchange ü§´</p>

    <div id="loadingSection" class="loading">
      <div>üîÑ Connecting to Firebase...</div>
    </div>

    <div id="errorSection" class="error" style="display: none;">
      <div id="errorMessage"></div>
    </div>

    <div id="connectedStatus" class="connected-status" style="display: none;">
      ‚úÖ Connected! Real-time sync is active.
    </div>

    <div id="gameContainer" style="display: none;">
      <div id="initialPrompt" class="initial-prompt">
        <h2>üéÑ Welcome to Our Family Gift Exchange! üéÑ</h2>
        <p>‚ú® Ready to discover your secret gift assignment? ‚ú®</p>
        <p><strong>üëá Click your name below to get started! üëá</strong></p>
      </div>

      <div id="welcomeMessage" class="welcome-message">
        <h2 id="welcomeText">Welcome!</h2>
        <p>Now choose your lucky number to discover your secret assignment!</p>
      </div>

      <div class="status-section">
        <div class="progress" id="progressCounter">Completed: 0/8</div>
        <div class="completed-list" id="completedList"></div>
        <button id="resetButton" class="reset-button" style="display: none;" onclick="resetGame()">
          üîÑ Reset Game (Admin)
        </button>
      </div>

      <div class="instructions">
        <h3>üéØ How It Works</h3>
        <ol>
          <li><strong>Select Your Name:</strong> Click your name from the family grid below</li>
          <li><strong>Pick a Number:</strong> Choose from available numbers (1-8). Your own number is blocked!</li>
          <li><strong>Secret Assignment:</strong> See who you're buying a gift for (keep it secret! ü§´)</li>
        </ol>
      </div>

      <div class="privacy-notice">
        <strong>üîí Privacy Guaranteed:</strong> The numbers are secretly shuffled! Only you will see your assignment. Once you choose, there's no going back!
      </div>

      <div id="deviceBlocked" class="device-blocked">
        <h3>üö´ Device Already Used</h3>
        <p>This device has already been used to make a selection. Each device can only be used once to ensure fairness.</p>
        <p>Please use a different device to make your selection.</p>
      </div>

      <div id="familyGrid" class="family-grid"></div>

      <div id="numbersSection" class="numbers-section">
        <h3 class="numbers-title">Choose Your Secret Number:</h3>
        <div class="numbers-grid" id="numbersGrid"></div>
      </div>

      <div id="assignmentResult" class="assignment-result">
        <h3>üéØ Your Secret Assignment:</h3>
        <p id="assignmentText"></p>
        <p style="margin-top: 20px; font-size: 1rem;">Keep this secret! This message will disappear when you leave the page.</p>
      </div>

      <div id="celebration" class="celebration">
        <h2>üéâ The Wainaina Family Exchange is Complete! üéâ</h2>
        <p>üéä Everyone has their secret assignment! üéä</p>
        <p>üõçÔ∏è Time to start shopping for your special person! üõçÔ∏è</p>
        <p>üéÑ Wishing our wonderful family a magical December! ‚ú®</p>
        <p style="margin-top: 25px; font-size: 1.1rem; font-style: italic;">
          "The best gifts are those given with love." ‚ù§Ô∏è
        </p>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC-FPjG0-hjhG84CibNVJrIKwsD_W37fSg",
      authDomain: "the-wainainas.firebaseapp.com",
      databaseURL: "https://the-wainainas-default-rtdb.firebaseio.com",
      projectId: "the-wainainas",
      storageBucket: "the-wainainas.firebasestorage.app",
      messagingSenderId: "604385180939",
      appId: "1:604385180939:web:e34fdc9c3cfbe20117360e",
      measurementId: "G-PF6D3V8L3C"
    };

    const familyMembers = ['Mum', 'Dad', 'Sherry', 'Nancy', 'B', 'Pius', 'Kui', 'Turi'];
    let gameState = {};
    let database, gameRef;
    let currentPlayer = null;
    let deviceId = generateDeviceId();
    let userIP = null;

    function generateDeviceId() {
      const stored = localStorage.getItem('deviceId');
      if (stored) return stored;
      const id = 'device_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
      localStorage.setItem('deviceId', id);
      return id;
    }

    async function fetchUserIP() {
      try {
        const res = await fetch('https://api.ipify.org?format=json');
        const data = await res.json();
        userIP = data.ip;
      } catch (err) {
        console.error("Failed to fetch IP:", err);
        userIP = "unknown_" + Math.random().toString(36).substr(2,5);
      }
    }

    function shuffleArray(array) {
      const shuffled = [...array];
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      return shuffled;
    }

    function createSecretMapping() {
      const numbers = [1,2,3,4,5,6,7,8];
      const shuffled = shuffleArray(familyMembers);
      const map = {};
      numbers.forEach((n,i)=> map[n] = shuffled[i]);
      return map;
    }

    function initializeApp() {
      firebase.initializeApp(firebaseConfig);
      database = firebase.database();
      gameRef = database.ref('giftExchange');
      setupGameStateListener();
    }

    function setupGameStateListener() {
      const defaultState = {
        completedPlayers: [],
        usedNumbers: [],
        usedDevices: [],
        usedIPs: [],
        secretMapping: createSecretMapping(),
        totalCompleted: 0
      };

      gameRef.once('value').then(snapshot => {
        const data = snapshot.val();
        gameState = data ? { ...defaultState, ...data } : defaultState;
        if (!data) gameRef.set(gameState);

        showGameInterface();
        updateUI();
        document.getElementById('connectedStatus').style.display = 'block';
        document.getElementById('loadingSection').style.display = 'none';

        gameRef.on('value', snap => {
          const updated = snap.val();
          if (updated) {
            gameState = { ...defaultState, ...updated };
            updateUI();
          }
        });
      }).catch(err => {
        showError('Database connection error: ' + err.message);
      });
    }

    function renderFamilyGrid() {
      const grid = document.getElementById('familyGrid');
      grid.innerHTML = '';
      familyMembers.forEach(name => {
        const div = document.createElement('div');
        div.className = 'family-member';
        if (Array.isArray(gameState.completedPlayers) && gameState.completedPlayers.includes(name)) {
          div.classList.add('completed');
          div.innerHTML = `${name} ‚úÖ`;
        } else {
          div.innerText = name;
        }
        div.onclick = ()=>selectPlayer(name);
        grid.appendChild(div);
      });
    }

    function renderNumbersGrid() {
      const grid = document.getElementById('numbersGrid');
      grid.innerHTML = '';
      for (let n=1;n<=8;n++) {
        const div = document.createElement('div');
        div.className = 'number-btn';
        if (Array.isArray(gameState.usedNumbers) && gameState.usedNumbers.includes(n)) {
          div.classList.add('used');
          div.innerHTML = `${n} ‚ùå`;
        } else if (gameState.secretMapping[n] === currentPlayer) {
          div.classList.add('used');
          div.innerHTML = `${n} üö´`;
          div.title = "This is your own number!";
        } else {
          div.innerText = n;
        }
        div.onclick = ()=>selectNumber(n);
        grid.appendChild(div);
      }
    }

    function selectPlayer(name) {
      if (Array.isArray(gameState.completedPlayers) && gameState.completedPlayers.includes(name)) return;

      if (
        (Array.isArray(gameState.usedDevices) && gameState.usedDevices.includes(deviceId)) ||
        (Array.isArray(gameState.usedIPs) && gameState.usedIPs.includes(userIP))
      ) {
        document.getElementById('deviceBlocked').style.display='block';
        return;
      }

      currentPlayer = name;
      
      // Hide initial prompt and show welcome message
      document.getElementById('initialPrompt').style.display = 'none';
      document.getElementById('welcomeMessage').style.display = 'block';
      document.getElementById('welcomeText').innerText = `Welcome, ${name}! üëã`;
      
      document.getElementById('numbersSection').style.display='block';
      renderNumbersGrid();
    }

    function selectNumber(n) {
      if (!currentPlayer) return;
      if (Array.isArray(gameState.usedNumbers) && gameState.usedNumbers.includes(n)) return;
      if (gameState.secretMapping[n] === currentPlayer) {
        alert("‚ùå You cannot pick your own number!");
        return;
      }

      gameState.usedNumbers.push(n);
      gameState.completedPlayers.push(currentPlayer);
      gameState.usedDevices.push(deviceId);
      if (userIP) gameState.usedIPs.push(userIP);
      gameState.totalCompleted++;

      gameRef.set(gameState);

      document.getElementById('assignmentText').innerHTML = 
        `<strong>${currentPlayer}</strong>, you will buy a gift for:<br><br>üéÅ <strong style="font-size: 1.4em; color: #ffffff;">${gameState.secretMapping[n]}</strong> üéÅ`;
      document.getElementById('assignmentResult').style.display='block';
      document.getElementById('numbersSection').style.display='none';
      document.getElementById('welcomeMessage').style.display='none';
    }

    function updateUI() {
      renderFamilyGrid();
      if (gameState.totalCompleted >= 8) {
        document.getElementById('celebration').style.display='block';
        document.getElementById('initialPrompt').style.display='none';
      } else if (gameState.totalCompleted === 0) {
        document.getElementById('initialPrompt').style.display='block';
      }
      
      document.getElementById('progressCounter').innerText = `Completed: ${gameState.totalCompleted}/8`;
      
      const completedText = gameState.completedPlayers && gameState.completedPlayers.length > 0 
        ? `Participated: ${gameState.completedPlayers.join(', ')}`
        : 'No one has participated yet';
      document.getElementById('completedList').innerText = completedText;
      
      // Show admin reset button if there are any completions
      if (gameState.totalCompleted > 0) {
        document.getElementById('resetButton').style.display = 'inline-block';
      }
    }

    function resetGame() {
      if (!confirm('Are you sure you want to reset the entire game? This will clear all assignments!')) {
        return;
      }
      
      gameState = {
        completedPlayers: [],
        usedNumbers: [],
        usedDevices: [],
        usedIPs: [],
        secretMapping: createSecretMapping(),
        totalCompleted: 0
      };
      gameRef.set(gameState);
      updateUI();
      document.getElementById('assignmentResult').style.display='none';
      document.getElementById('celebration').style.display='none';
      document.getElementById('numbersSection').style.display='none';
      document.getElementById('welcomeMessage').style.display='none';
      document.getElementById('deviceBlocked').style.display='none';
      currentPlayer = null;
    }

    function showError(msg) {
      document.getElementById('errorSection').style.display='block';
      document.getElementById('errorMessage').innerText=msg;
    }

    function showGameInterface() {
      document.getElementById('gameContainer').style.display='block';
    }

    // First fetch IP, then init Firebase
    fetchUserIP().then(() => {
      initializeApp();
    });
  </script>
</body>
</html>