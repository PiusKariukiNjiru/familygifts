<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>🎁 Secret Family Gift Exchange</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9f9f9;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: auto;
      background: #fff;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      color: #333;
    }
    .subtitle {
      text-align: center;
      font-size: 0.95rem;
      color: #555;
      margin-bottom: 20px;
    }
    .loading, .error, .connected-status {
      text-align: center;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }
    .loading { background: #eaf4ff; color: #0056b3; }
    .error { background: #ffeaea; color: #c00; }
    .connected-status { background: #eaffea; color: #006600; }
    .status-section { margin-bottom: 15px; }
    .progress { font-weight: bold; }
    .completed-list { margin-top: 10px; font-size: 0.9rem; color: #444; }
    .reset-button {
      margin-top: 10px;
      padding: 8px 15px;
      border: none;
      background: #c00;
      color: #fff;
      border-radius: 6px;
      cursor: pointer;
    }
    .instructions {
      margin: 20px 0;
      background: #f1faff;
      padding: 15px;
      border-radius: 8px;
    }
    .privacy-notice {
      margin-bottom: 20px;
      padding: 12px;
      background: #fff5e6;
      border-radius: 8px;
      font-size: 0.95rem;
    }
    .device-blocked {
      display: none;
      padding: 15px;
      background: #ffeaea;
      border: 1px solid #c00;
      border-radius: 8px;
      margin-bottom: 20px;
      text-align: center;
    }
    .family-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }
    .family-member {
      padding: 12px;
      background: #f0f0f0;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: background 0.2s;
    }
    .family-member:hover { background: #d0ebff; }
    .family-member.completed { background: #e6ffe6; cursor: not-allowed; }
    .numbers-section { display: none; margin-bottom: 20px; }
    .numbers-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }
    .number-btn {
      padding: 12px;
      background: #f0f0f0;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: background 0.2s;
    }
    .number-btn:hover { background: #d0ebff; }
    .number-btn.used { background: #ffeaea; cursor: not-allowed; }
    .assignment-result {
      display: none;
      padding: 15px;
      background: #f9f9ff;
      border-radius: 8px;
      text-align: center;
    }
    .celebration {
      display: none;
      padding: 20px;
      background: #e6ffe6;
      border-radius: 8px;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>🎁 Secret Family Gift Exchange 🤫</h1>
    <p class="subtitle">December 2025 • Real-Time Synchronized</p>

    <div id="loadingSection" class="loading">
      <div>🔄 Connecting to Firebase...</div>
    </div>

    <div id="errorSection" class="error" style="display: none;">
      <div id="errorMessage"></div>
    </div>

    <div id="connectedStatus" class="connected-status" style="display: none;">
      ✅ Connected to Firebase! Real-time sync active.
    </div>

    <div id="gameContainer" style="display: none;">
      <div class="status-section">
        <div class="progress" id="progressCounter">Completed: 0/8</div>
        <div class="completed-list" id="completedList"></div>
        <button id="resetButton" class="reset-button" style="display: none;" onclick="resetGame()">
          🔄 Reset Game (Admin)
        </button>
      </div>

      <div class="instructions">
        <h3>🎯 How It Works</h3>
        <ol>
          <li><strong>Select Your Name:</strong> Click your name from the family grid below</li>
          <li><strong>Pick a Number:</strong> Choose from available numbers (1-8). Your own number is blocked!</li>
          <li><strong>Secret Assignment:</strong> See who you're buying a gift for (keep it secret! 🤫)</li>
        </ol>
      </div>

      <div class="privacy-notice">
        <strong>🔒 Privacy Guaranteed:</strong> The numbers are secretly shuffled! Only you will see your assignment. Once you choose, there's no going back!
      </div>

      <div id="deviceBlocked" class="device-blocked">
        <h3>🚫 Device Already Used</h3>
        <p>This device has already been used to make a selection. Each device can only be used once to ensure fairness.</p>
        <p>Please use a different device to make your selection.</p>
      </div>

      <div id="familyGrid" class="family-grid"></div>

      <div id="numbersSection" class="numbers-section">
        <h3 class="numbers-title">Choose Your Secret Number:</h3>
        <div class="numbers-grid" id="numbersGrid"></div>
      </div>

      <div id="assignmentResult" class="assignment-result">
        <h3>🎯 Your Secret Assignment:</h3>
        <p id="assignmentText"></p>
        <p style="margin-top: 15px; font-size: 0.9rem;">Keep this secret! This message will disappear when you leave the page.</p>
      </div>

      <div id="celebration" class="celebration">
        <h2>🎉 All Gift Assignments Complete! 🎉</h2>
        <p>Everyone has their secret assignment! Time to start shopping! 🛍️</p>
        <p style="margin-top: 15px; font-size: 1rem;">Happy December Gift Exchange! 🎄✨</p>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC-FPjG0-hjhG84CibNVJrIKwsD_W37fSg",
      authDomain: "the-wainainas.firebaseapp.com",
      databaseURL: "https://the-wainainas-default-rtdb.firebaseio.com",
      projectId: "the-wainainas",
      storageBucket: "the-wainainas.firebasestorage.app",
      messagingSenderId: "604385180939",
      appId: "1:604385180939:web:e34fdc9c3cfbe20117360e",
      measurementId: "G-PF6D3V8L3C"
    };

    const familyMembers = ['Mum', 'Dad', 'Sherry', 'Nancy', 'B', 'Pius', 'Kui', 'Turi'];
    let gameState = {};
    let database, gameRef;
    let currentPlayer = null;
    let deviceId = generateDeviceId();
    let userIP = null;

    function generateDeviceId() {
      const stored = localStorage.getItem('deviceId');
      if (stored) return stored;
      const id = 'device_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
      localStorage.setItem('deviceId', id);
      return id;
    }

    async function fetchUserIP() {
      try {
        const res = await fetch('https://api.ipify.org?format=json');
        const data = await res.json();
        userIP = data.ip;
      } catch (err) {
        console.error("Failed to fetch IP:", err);
        userIP = "unknown_" + Math.random().toString(36).substr(2,5);
      }
    }

    function shuffleArray(array) {
      const shuffled = [...array];
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      return shuffled;
    }

    function createSecretMapping() {
      const numbers = [1,2,3,4,5,6,7,8];
      const shuffled = shuffleArray(familyMembers);
      const map = {};
      numbers.forEach((n,i)=> map[n] = shuffled[i]);
      return map;
    }

    function initializeApp() {
      firebase.initializeApp(firebaseConfig);
      database = firebase.database();
      gameRef = database.ref('giftExchange');
      setupGameStateListener();
    }

    function setupGameStateListener() {
      const defaultState = {
        completedPlayers: [],
        usedNumbers: [],
        usedDevices: [],
        usedIPs: [],   // ✅ added
        secretMapping: createSecretMapping(),
        totalCompleted: 0
      };

      gameRef.once('value').then(snapshot => {
        const data = snapshot.val();
        gameState = data ? { ...defaultState, ...data } : defaultState;
        if (!data) gameRef.set(gameState);

        showGameInterface();
        updateUI();
        document.getElementById('connectedStatus').style.display = 'block';
        document.getElementById('loadingSection').style.display = 'none';

        gameRef.on('value', snap => {
          const updated = snap.val();
          if (updated) {
            gameState = { ...defaultState, ...updated };
            updateUI();
          }
        });
      }).catch(err => {
        showError('DB error: ' + err.message);
      });
    }

    function renderFamilyGrid() {
      const grid = document.getElementById('familyGrid');
      grid.innerHTML = '';
      familyMembers.forEach(name => {
        const div = document.createElement('div');
        div.className = 'family-member';
        if (Array.isArray(gameState.completedPlayers) && gameState.completedPlayers.includes(name)) {
          div.classList.add('completed');
        }
        div.innerText = name;
        div.onclick = ()=>selectPlayer(name);
        grid.appendChild(div);
      });
    }

    function renderNumbersGrid() {
      const grid = document.getElementById('numbersGrid');
      grid.innerHTML = '';
      for (let n=1;n<=8;n++) {
        const div = document.createElement('div');
        div.className = 'number-btn';
        if (Array.isArray(gameState.usedNumbers) && gameState.usedNumbers.includes(n)) {
          div.classList.add('used');
        }
        div.innerText = n;
        div.onclick = ()=>selectNumber(n);
        grid.appendChild(div);
      }
    }

    function selectPlayer(name) {
      if (Array.isArray(gameState.completedPlayers) && gameState.completedPlayers.includes(name)) return;

      if (
        (Array.isArray(gameState.usedDevices) && gameState.usedDevices.includes(deviceId)) ||
        (Array.isArray(gameState.usedIPs) && gameState.usedIPs.includes(userIP))
      ) {
        document.getElementById('deviceBlocked').style.display='block';
        return;
      }

      currentPlayer = name;
      document.getElementById('numbersSection').style.display='block';
      renderNumbersGrid();
    }

    function selectNumber(n) {
      if (!currentPlayer) return;
      if (Array.isArray(gameState.usedNumbers) && gameState.usedNumbers.includes(n)) return;
      if (gameState.secretMapping[n] === currentPlayer) {
        alert("❌ You cannot pick your own number!");
        return;
      }

      gameState.usedNumbers.push(n);
      gameState.completedPlayers.push(currentPlayer);
      gameState.usedDevices.push(deviceId);
      if (userIP) gameState.usedIPs.push(userIP);  // ✅ store IP
      gameState.totalCompleted++;

      gameRef.set(gameState);

      document.getElementById('assignmentText').innerText =
        currentPlayer + ', you will buy a gift for: ' + gameState.secretMapping[n];
      document.getElementById('assignmentResult').style.display='block';
      document.getElementById('numbersSection').style.display='none';
    }

    function updateUI() {
      renderFamilyGrid();
      if (gameState.totalCompleted >= 8) {
        document.getElementById('celebration').style.display='block';
      }
      document.getElementById('progressCounter').innerText = 'Completed: ' + gameState.totalCompleted + '/8';
      document.getElementById('completedList').innerText = 'Done: ' + (gameState.completedPlayers || []).join(', ');
    }

    function resetGame() {
      gameState = {
        completedPlayers: [],
        usedNumbers: [],
        usedDevices: [],
        usedIPs: [],   // ✅ reset IPs
        secretMapping: createSecretMapping(),
        totalCompleted: 0
      };
      gameRef.set(gameState);
      updateUI();
      document.getElementById('assignmentResult').style.display='none';
      document.getElementById('celebration').style.display='none';
    }

    function showError(msg) {
      document.getElementById('errorSection').style.display='block';
      document.getElementById('errorMessage').innerText=msg;
    }

    function showGameInterface() {
      document.getElementById('gameContainer').style.display='block';
    }

    // ✅ First fetch IP, then init Firebase
    fetchUserIP().then(() => {
      initializeApp();
    });
  </script>
</body>
</html>
