<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>The Wainaina's 🎁 Gift Exchange</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #fdfdfd;
      color: #333;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }
    .container {
      max-width: 700px;
      margin: 30px auto;
      background: white;
      border-radius: 20px;
      padding: 25px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      text-align: center;
    }
    h1 {
      margin: 0;
      font-size: 2rem;
      color: #444;
    }
    .subtitle {
      font-size: 1rem;
      color: #777;
      margin-bottom: 20px;
    }
    .instructions {
      background: #f0f9ff;
      padding: 10px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-size: 0.95rem;
    }
    .family-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    .family-member {
      background: #f8f8f8;
      border: 2px solid #ddd;
      border-radius: 12px;
      padding: 20px;
      cursor: pointer;
      font-weight: bold;
      transition: 0.2s;
    }
    .family-member:hover {
      background: #e0f7ff;
      border-color: #00aaff;
    }
    .numbers-section {
      display: none;
      margin-top: 25px;
    }
    .welcome-text {
      font-size: 1.2rem;
      margin-bottom: 10px;
      color: #0077aa;
      font-weight: bold;
    }
    .numbers-title {
      font-size: 1.1rem;
      margin-bottom: 10px;
    }
    .numbers-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }
    .number-btn {
      padding: 15px;
      background: #f4f4f4;
      border-radius: 12px;
      cursor: pointer;
      font-size: 1.1rem;
      transition: 0.2s;
    }
    .number-btn:hover {
      background: #c2f0ff;
    }
    .number-btn.taken {
      background: #ffcccc;
      cursor: not-allowed;
    }
    .assignment-result {
      display: none;
      margin-top: 25px;
      background: #fdf2d0;
      padding: 20px;
      border-radius: 12px;
      font-size: 1.1rem;
    }
    .celebration {
      display: none;
      margin-top: 25px;
      background: #e6ffed;
      padding: 25px;
      border-radius: 15px;
      font-size: 1.2rem;
      font-weight: bold;
      color: #006600;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>The Wainaina's 🎄</h1>
    <p class="subtitle">Secret Family Gift Exchange • December 2025</p>

    <div id="loadingSection">🔄 Connecting to Firebase...</div>
    <div id="errorSection" style="display:none; color:red;"></div>

    <div id="gameContainer" style="display:none;">
      <div class="instructions" id="promptMessage">
        👆 Please click your name to begin.
      </div>

      <div class="family-grid" id="familyGrid"></div>

      <div class="numbers-section" id="numbersSection">
        <div class="welcome-text" id="welcomeText"></div>
        <div class="numbers-title">Choose your secret number:</div>
        <div class="numbers-grid" id="numbersGrid"></div>
      </div>

      <div class="assignment-result" id="assignmentResult">
        <h3>🎯 Your Secret Assignment:</h3>
        <p id="assignmentText"></p>
      </div>

      <div class="celebration" id="celebration">
        🎉 All assignments are complete! Everyone has their secret gift buddy.  
        Time to start shopping 🛍️🎄✨
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC-FPjG0-hjhG84CibNVJrIKwsD_W37fSg",
      authDomain: "the-wainainas.firebaseapp.com",
      databaseURL: "https://the-wainainas-default-rtdb.firebaseio.com",
      projectId: "the-wainainas",
      storageBucket: "the-wainainas.firebasestorage.app",
      messagingSenderId: "604385180939",
      appId: "1:604385180939:web:e34fdc9c3cfbe20117360e",
      measurementId: "G-PF6D3V8L3C"
    };

    const familyMembers = ['Mum', 'Dad', 'Sherry', 'Nancy', 'B', 'Pius', 'Kui', 'Turi'];
    let gameState = { completedPlayers: [], usedNumbers: [], usedDevices: [], usedIPs: [], secretMapping: {}, totalCompleted: 0 };
    let database, gameRef;
    let currentPlayer = null;
    let deviceId = generateDeviceId();
    let userIP = null;

    function generateDeviceId() {
      const stored = localStorage.getItem('deviceId');
      if (stored) return stored;
      const id = 'device_' + Math.random().toString(36).substr(2, 9);
      localStorage.setItem('deviceId', id);
      return id;
    }

    async function fetchUserIP() {
      try {
        const res = await fetch('https://api.ipify.org?format=json');
        const data = await res.json();
        userIP = data.ip;
      } catch (e) {
        userIP = "unknown_" + Math.random().toString(36).substr(2,5);
      }
    }

    function shuffleArray(arr) {
      const a = [...arr];
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i+1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function createSecretMapping() {
      const numbers = [1,2,3,4,5,6,7,8];
      const shuffled = shuffleArray(familyMembers);
      const mapping = {};
      numbers.forEach((n,i) => mapping[n] = shuffled[i]);
      return mapping;
    }

    function initializeApp() {
      firebase.initializeApp(firebaseConfig);
      database = firebase.database();
      gameRef = database.ref('giftExchange');
      setupGameStateListener();
    }

    function setupGameStateListener() {
      const defaultState = {
        completedPlayers: [],
        usedNumbers: [],
        usedDevices: [],
        usedIPs: [],
        secretMapping: createSecretMapping(),
        totalCompleted: 0
      };
      gameRef.once('value', snap => {
        const data = snap.val();
        gameState = data ? { ...defaultState, ...data } : defaultState;
        if (!data) gameRef.set(gameState);
        showGame();
        gameRef.on('value', snap => {
          const data = snap.val();
          if (data) {
            gameState = { ...defaultState, ...data };
            updateUI();
          }
        });
      });
    }

    function showGame() {
      document.getElementById('loadingSection').style.display = 'none';
      document.getElementById('gameContainer').style.display = 'block';
      renderFamilyGrid();
      updateUI();
    }

    function renderFamilyGrid() {
      const grid = document.getElementById('familyGrid');
      grid.innerHTML = '';
      familyMembers.forEach(name => {
        const btn = document.createElement('div');
        btn.className = 'family-member';
        btn.innerText = name;
        btn.onclick = () => selectPlayer(name);
        grid.appendChild(btn);
      });
    }

    function renderNumbersGrid() {
      const grid = document.getElementById('numbersGrid');
      grid.innerHTML = '';
      for (let n=1; n<=8; n++) {
        const btn = document.createElement('div');
        btn.className = 'number-btn';
        btn.innerText = n;
        if (gameState.usedNumbers.includes(n) || gameState.secretMapping[n] === currentPlayer) {
          btn.classList.add('taken');
        } else {
          btn.onclick = () => selectNumber(n);
        }
        grid.appendChild(btn);
      }
    }

    function selectPlayer(name) {
      if (gameState.completedPlayers.includes(name)) return;
      if (gameState.usedDevices.includes(deviceId) || gameState.usedIPs.includes(userIP)) {
        alert("🚫 This device/IP has already been used!");
        return;
      }
      currentPlayer = name;
      document.getElementById('welcomeText').innerText = "Welcome, " + name + " 🎉";
      document.getElementById('numbersSection').style.display = 'block';
      renderNumbersGrid();
    }

    function selectNumber(n) {
      if (!currentPlayer) return;
      if (gameState.usedNumbers.includes(n)) return;
      if (gameState.secretMapping[n] === currentPlayer) {
        alert("❌ You cannot pick your own number!");
        return;
      }
      gameState.usedNumbers.push(n);
      gameState.completedPlayers.push(currentPlayer);
      gameState.usedDevices.push(deviceId);
      if (userIP) gameState.usedIPs.push(userIP);
      gameState.totalCompleted++;
      gameRef.set(gameState);
      document.getElementById('assignmentText').innerText =
        currentPlayer + ", you will buy a gift for: " + gameState.secretMapping[n];
      document.getElementById('assignmentResult').style.display = 'block';
    }

    function updateUI() {
      if (gameState.totalCompleted >= familyMembers.length) {
        document.getElementById('celebration').style.display = 'block';
      }
    }

    fetchUserIP().then(() => initializeApp());
  </script>
</body>
</html>
